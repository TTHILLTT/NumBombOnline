{% load i18n %}
{% load static %}

<html lang="{% translate 'lang' %}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% translate 'Playing' %}</title>
    {% include 'style.html' %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #fff;
            margin: 0;
            flex-direction: column;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            position: relative;
        }

        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 25px;
            text-align: center;
            border-bottom: 3px solid #ff5722;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #ff8a00, #da1b60);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            padding: 30px;
        }

        .card {
            background: rgba(30, 30, 50, 0.9);
            border-radius: 15px;
            padding: 0 25px 25px 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            width: 50%;
        }

        .card-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #ff9800;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-container {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #e0e0e0;
        }

        input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 2px solid #444;
            background: rgba(20, 20, 30, 0.8);
            color: white;
            font-size: 1.1rem;
            transition: border-color 0.3s;
        }

        input:focus {
            border-color: #ff5722;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 87, 34, 0.3);
        }

        button {
            background: linear-gradient(to right, #ff5722, #ff9800);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 87, 34, 0.4);
        }

        button:active {
            transform: translateY(1px);
        }

        .btn-full {
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }

        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .player-tag {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid #ff9800;
            border-radius: 50px;
            padding: 8px 20px;
            display: inline-block;
            align-items: center;
            gap: 8px;
        }

        .player-tag .fa-user {
            color: #ff9800;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            margin: 25px 0;
            gap: 20px;
        }

        .info-box {
            flex: 1;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .info-box h3 {
            color: #ff9800;
            margin-bottom: 10px;
        }

        .info-value {
            font-size: 2rem;
            font-weight: 700;
            color: #ff5722;
        }

        .current-player {
            text-align: center;
            font-size: 1.8rem;
            margin: 25px 0;
            color: #ff5722;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .range-display {
            text-align: center;
            font-size: 1.6rem;
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ff5722;
            width: max-content;
            display: inline-block
        }

        .boom-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .boom-text {
            font-size: 8rem;
            font-weight: 900;
            color: #ff0000;
            text-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
            animation: boom 0.5s infinite alternate;
        }

        @keyframes boom {
            from {
                transform: scale(1);
            }

            to {
                transform: scale(1.2);
            }
        }

        .result-container {
            text-align: center;
            margin-top: 40px;
        }

        .result-title {
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: #ff9800;
        }

        .winner,
        .loser {
            font-size: 1.8rem;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
        }

        .winner {
            background: rgba(0, 150, 0, 0.3);
            color: #4caf50;
        }

        .loser {
            background: rgba(200, 0, 0, 0.3);
            color: #f44336;
        }

        .cheat-note {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .hidden {
            display: none;
        }

        .player-input {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .player-input input {
            flex: 1;
        }

        .player-input button {
            flex: 0 0 auto;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .game-info {
                flex-direction: column;
            }

            .current-player {
                font-size: 1.5rem;
            }

            .boom-text {
                font-size: 5rem;
            }
        }

        body:not(.owner) .owner-only {
            display: none;
        }

        body:not(.ordering) .show-ordering {
            display: none;
        }

        body.playing .hide-playing {
            display: none;
        }

        body.preparing .hide-preparing {
            display: none;
        }   

        body:not(.preparing) .show-preparing {
            display: none;
        }

        a {
            text-decoration: none;
            color: #fff;
            background: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .player-tag.inactive {
            background: rgba(131, 131, 131, 0.1);
            border-color: #9e9e9e;
        }
    </style>
    {% include 'jquery.html' %}
    {% include 'humps.html' %}
    <script>
        const ROOM_ID = parseInt("{{ room.id }}");
        let ended = false;
        let ws = undefined;

        const clientStatus = {
            username: undefined,
            room: undefined,
            playerInfo: {},
            roomData: {
                _name: undefined,
                set name(value) {
                    this._name = value;
                    $("#room-name").text(value);
                },
                get name() {
                    return this._name;
                },

                _owner: undefined,
                set owner(value) {
                    this._owner = value;
                    $("#owner").text(value);
                },
                get owner() {
                    return this._owner;
                },

                _order: [],
                set order(value) {
                    this._order = value;
                    updatePlayerList();
                },
                get order() {
                    return this._order;
                },

                _currentPlayer: undefined,
                set currentPlayer(value) {
                    this._currentPlayer = value;
                    $("#current-player").text(value);
                },
                get currentPlayer() {
                    return this._currentPlayer;
                },

                _readyPlayers: [],
                set readyPlayers(value) {
                    this._readyPlayers = value;
                    $(".player-status").text("{% translate 'Not Ready' %}");
                    value.forEach(user => {
                        $(`[data-username="${user}"] .player-status`).text("{% translate 'Ready' %}");
                    });
                },
                get readyPlayers() {
                    return this._readyPlayers;
                },

                _status: undefined,
                set status(value) {
                    this._status = value;
                    $("body").removeClass("joining ordering preparing playing end").addClass(value);

                    const statusMap = {
                        'joining': "{% translate 'Waiting for players to join...' %}",
                        'ordering': "{% translate 'Ordering players...' %}",
                        'preparing': "{% translate 'Preparing game...' %}",
                        'playing': "{% translate 'Game in progress...' %}",
                        'end': "{% translate 'Game ended...' %}"
                    };

                    $("#status").text(statusMap[value] || "");

                    const statusMapBtn = {
                        "joining": "{% translate 'Lock Room' %}",
                        "ordering": "{% translate 'Lock Order' %}",
                    }

                    $("#next-step-btn").text(statusMapBtn[value] || "");
                },
                get status() {
                    return this._status;
                },

                _range: [undefined, undefined],
                set range(value) {
                    this._range = value;
                    $("#current-range").text(`${value[0]} ~ ${value[1]}`);
                },
                get range() {
                    return this._range;
                },
            },
            _isOwner: false,
            set isOwner(value) {
                this._isOwner = value;
                $("body").toggleClass("owner", value);
                if (value) {
                    $("#close-room-btn-prepare, #close-room-btn-playing").text("{% translate 'Close Room' %}");
                } else {
                    $("#close-room-btn-prepare, #close-room-btn-playing").text("{% translate 'Leave Room' %}");
                }
            },
            get isOwner() {
                return this._isOwner;
            }
        };

        function updatePlayerList() {
            const order = clientStatus.roomData.order;
            $("#player-list").empty();
            $("#players").empty();
            order.forEach(user => {
                $("#player-list").append(
                    /*html*/`
                    <tr data-username="${user}">
                        <td>${user}</td>
                        <td class="player-status">${clientStatus.roomData.readyPlayers.includes(user) ? "{% translate 'Ready' %}" : "{% translate 'Not Ready' %}"}</td>
                        <td class="owner-only">
                            <button class="btn hide-playing">{% translate 'Kick' %}</button>
                            <button class="btn show-ordering">{% translate 'Move Up' %}</button>
                            <button class="btn show-ordering">{% translate 'Move Down' %}</button>
                        </td>
                    </tr>`
                );
                $("#players").append(/*html*/`<span class="player-tag" data-username="${user}"><a href="{{ profile_url }}" target="_blank">${user}</a><span class="channel-count"></span></span>`);
            });
            $("#player-count").text(`${order.length}`);
        }

        function getWSUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const host = window.location.host;
            const path = '/ws/';
            return protocol + '://' + host + path;
        }

        function updateChannelCount(username, channelCount) {
            clientStatus.playerInfo[username] ||= {};
            clientStatus.playerInfo[username].channelCount = channelCount;
            $(`[data-username="${username}"] .channel-count`).text(`(${channelCount})`);
            $(`[data-username="${username}"]`).toggleClass("inactive", channelCount === 0);
        }

        function connectToWS() {
            ws = new WebSocket(getWSUrl());
            ws.onopen = function (event) {
                console.log('Socket opened');
                sendData({
                    type: 'action',
                    action: 'join',
                    data: {
                        roomId: ROOM_ID,
                    }
                });
            };
            ws.onmessage = function (event) {
                console.log('Received message:', event.data);
                const message = humps.camelizeKeys(JSON.parse(event.data));
                switch (message.type) {
                    case 'event':
                        switch (message.event) {
                            case 'join':
                                updateChannelCount(message.data.user, message.data.userChannelCount);
                                if (clientStatus.roomData.order.includes(message.data.user)) {
                                    return;
                                }
                                clientStatus.roomData.order.push(message.data.user);
                                $("#player-list").append(
                                    /*html*/`
                                    <tr data-username="${message.data.user}">
                                        <td>${message.data.user}</td>
                                        <td class="player-status">{% translate 'Not Ready' %}</td>
                                        <td class="owner-only">
                                            <button class="btn hide-playing">{% translate 'Kick' %}</button>
                                            <button class="btn show-ordering">{% translate 'Move Up' %}</button>
                                            <button class="btn show-ordering">{% translate 'Move Down' %}</button>
                                        </td>
                                    </tr>`
                                );
                                break;
                            case 'disconnect':
                                updateChannelCount(message.data.user, message.data.userChannelCount);
                                break;
                            case 'leave':
                                clientStatus.roomData.order.splice(clientStatus.roomData.order.indexOf(message.data.user), 1);
                                $(`[data-username="${message.data.user}"]`).remove();
                                break;
                            case 'kick':
                                clientStatus.roomData.order.splice(clientStatus.roomData.order.indexOf(message.data.user), 1);
                                $(`[data-username="${message.data.user}"]`).remove();
                            case 'deactive':
                                {
                                    const endMessage = "{% translate 'Room has been Closed' %}";
                                    alert(endMessage);
                                    clientStatus.roomData.status = 'end';
                                    end(endMessage);
                                }
                                break;
                            case 'next':
                                clientStatus.roomData.status = message.data.status;
                                break;
                            case 'ready':
                                clientStatus.roomData.readyPlayers.push(message.data.user);
                                $(`[data-username="${message.data.user}"] .player-status`).text("{% translate 'Ready' %}");
                                break;
                            case 'unready':
                                clientStatus.roomData.readyPlayers.splice(clientStatus.roomData.readyPlayers.indexOf(message.data.user), 1);
                                $(`[data-username="${message.data.user}"] .player-status`).text("{% translate 'Not Ready' %}");
                                break;
                            case 'start':
                                clientStatus.roomData.status = 'playing';
                                updatePlayerList();
                                break;
                            case 'lose':
                                {
                                    const endMessage = `{% blocktranslate with loser="${message.data.user}" answer="${message.data.answer}" %}{{ loser }} has lost the game. The Answer is {{ answer }}.{% endblocktranslate %}`;
                                    alert(endMessage);
                                    clientStatus.roomData.status = 'end';
                                    end(endMessage);
                                }
                                break;
                            case 'guess':
                                clientStatus.roomData.range = message.data.newRange;
                                clientStatus.roomData.currentPlayer = message.data.currentPlayer;
                                break;
                            case 'order':
                                clientStatus.roomData.order = message.data.order;
                                break;
                        }
                        break;
                    case 'status':
                        if (message.status === 'success') {
                            switch (message.action) {
                                case 'join':
                                    clientStatus.username = message.data.user;
                                    clientStatus.room = message.data.room;
                                    clientStatus.roomData.name = message.data.roomData.name;
                                    clientStatus.roomData.owner = message.data.roomData.owner;
                                    clientStatus.roomData.order = message.data.roomData.order;
                                    clientStatus.roomData.currentPlayer = message.data.roomData.currentPlayer;
                                    clientStatus.roomData.readyPlayers = message.data.roomData.readyPlayers;
                                    clientStatus.roomData.status = message.data.roomData.status;
                                    clientStatus.roomData.range = message.data.roomData.range;
                                    clientStatus.isOwner = message.data.isOwner;
                                    break;
                            }
                        } else {
                            alert(message.error);
                        }
                        break;
                    case 'error':
                        alert(message.error);
                        if (message.fatal) {
                            end(message.error);
                        }
                        break;
                    default:
                        console.log('Unknown message type:', message);
                        break;
                }
            };
            ws.onclose = function (event) {
                console.log('Socket closed');
                if (!ended) {
                    $("#disconnect-dialog")[0].showModal();
                }
            };
            ws.onerror = function (error) {
                console.log('Socket error:', error);
                if (!ended) {
                    $("#disconnect-dialog")[0].showModal();
                }
            };
        }

        function sendData(data) {
            data = humps.decamelizeKeys(data);
            console.log('Sending data:', data);
            ws.send(JSON.stringify(data));
        }

        function end(message) {
            window.close();
            ended = true;
            ws.close();
            document.body.innerHTML = message;
        }

        function closeOrLeave() {
            if (clientStatus.isOwner) {
                ans = confirm("{% translate 'Are you sure to close the room?' %}");
                if (ans) {
                    sendData({
                        type: 'action',
                        action: 'deactive',
                        data: {}
                    });
                }
            } else {
                if (clientStatus.roomData.status === 'playing') {
                    ans = confirm("{% translate 'The Game is in progress, are you sure to leave the room?' %}");
                    if (ans) {
                        end("{% translate 'You have left the room.' %}");
                    }
                } else {
                    sendData({
                        type: 'action',
                        action: 'leave',
                        data: {}
                    });
                    end("{% translate 'You have left the room.' %}");
                }
            }
        }

        function submitGuess() {
            const guess = $("#guess-input").val();
            if (!guess) {
                alert("请输入数字");
                return;
            }
            const currentPlayer = clientStatus.roomData.currentPlayer;
            sendData({
                type: 'action',
                action: 'guess',
                data: {
                    number: guess,
                }
            });
            $("#guess-input").val("").focus();
        }

        $(function () {
            $(".owner-only").hide();
            connectToWS();
            $("#disconnect-dialog").on("close", function () {
                connectToWS();
            });
        })
    </script>
</head>

<body>
    <dialog id="disconnect-dialog">
        <h2>{% translate 'Disconnected' %}</h2>
        <p>{% translate 'The connection to the server has been lost.' %}</p>
        <form method="dialog">
            <button class="btn" id="reconnect-btn">{% translate 'Reconnect' %}</button>
        </form>
    </dialog>

    <!-- 准备阶段 -->
    <div class="card" id="prepare-card">
        <h2 class="card-title"><i class="fas fa-hourglass-start"></i> 准备阶段</h2>

        <p>{% translate 'Status' %}: <span id="status">{% translate 'Waiting for players to join...' %}</span></p>
        <p>{% translate 'Players' %}</p>
        <table>
            <thead>
                <tr>
                    <th>玩家名</th>
                    <th>准备状态</th>
                    <th class="owner-only">操作</th>
                </tr>
            </thead>
            <tbody id="player-list">

            </tbody>
        </table>
        <p><button class="btn show-preparing" id="ready-btn" onclick="ws.send(JSON.stringify({type: 'action', action: 'ready', data: {}}))">{% translate 'Ready' %}</button></p>
        <p><button class="btn hide-preparing" id="next-step-btn" onclick="ws.send(JSON.stringify({type: 'action', action: 'next', data: {}}))">{% translate 'Lock Room' %}</button></p>
        <p><button class="btn" id="close-room-btn-prepare" onclick="closeOrLeave()">{% translate 'Close Room' %}</button></p>
    </div>

    <!-- 游玩阶段 -->
    <div class="card" id="game-card">
        <h2 class="card-title"><i class="fas fa-bomb"></i> 数字炸弹</h2>

        <div class="room-info">
            <p>房间名: <span id="room-name"></span><button class="btn" id="close-room-btn-playing" onclick="closeOrLeave()">{% translate 'Leave Room' %}</button></p>
            <p>房主: <span id="owner"></span></p>
            <p>玩家列表：<span id="players"></span></p>
        </div>

        <div class="game-info">
            <div class="info-box">
                <h3>当前范围</h3>
                <div class="range-display" id="current-range">
                    1 ~ 100
                </div>
            </div>

            <div class="info-box">
                <h3>玩家数</h3>
                <div class="info-value" id="player-count">
                    3
                </div>
            </div>
        </div>

        <div class="current-player">
            <span id="current-player">玩家1</span>的回合
        </div>

        <div>
            <p>{% translate 'Time Left' %}: <span id="time-left">10</span>s</p>
        </div>

        <div class="input-container">
            <label for="guess-input">输入你的猜测</label>
            <input type="text" id="guess-input" placeholder="输入范围内的数字" onkeydown="if (event.keyCode == 13) {submitGuess()}">
        </div>

        <button class="btn-full" id="guess-btn" onclick="submitGuess()">
            <i class="fas fa-paper-plane"></i> 提交答案
        </button>
    </div>
</body>

</html>